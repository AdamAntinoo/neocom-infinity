apiVersion: v1
kind: Service
metadata:
  name: $APP_CODE-$ENV-svc
  namespace: $NAMESPACE
spec:
  selector:
    app: $APP_CODE
    environment: $ENV
  type: NodePort
  ports:
    - nodePort: $EXPOSE_PORT
      protocol: TCP
      port: $PORT
      targetPort: $PORT
status:
  loadBalancer: {}

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: $APP_CODE-config
  namespace: $NAMESPACE
data:
  NODE_ENV: "$NODE_ENV"
  PORT: "$PORT"
  ENVIRONMENT: "$ENVIRONMENT"
  NODE_VERSION: "$NODE_VERSION"
  PRODUCTION: "$PRODUCTION"
  SEMVERSION: "$SEMVERSION"
  VERSION: "$VERSION"
  ESI_CLIENTID: "$ESI_CLIENTID"
  ESI_STATE: "$ESI_STATE"
  CALLBACK_URL: "$CALLBACK_URL"
  ESIPROXY: "$ESIPROXY"
  OAUTHPROXY: "$OAUTHPROXY"
  PUBLICPROXY: "$PUBLICPROXY"
  BACKENDPROXY: "$BACKENDPROXY"
  NESTPROXY: "$NESTPROXY"
  APP_CODE: "$APP_CODE"
  MODULE_NAME: "$MODULE_NAME"
  APP_HOME: "$APP_HOME"
  APP_BASEREF: "$APP_BASEREF"

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: $APP_CODE
  namespace: $NAMESPACE
  labels:
    app: $APP_CODE
    environment: $ENV
spec:
  selector:
    matchLabels:
      app: $APP_CODE
      environment: $ENV
  template:
    metadata:
      labels:
        app: $APP_CODE
        environment: $ENV
        version: "$VERSION"
        port: "$PORT"
        module: $MODULE_NAME
    spec:
      containers:
      - name: $APP_CODE
        image: adamantinoo/$IMAGE_TAG
        env:
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: NODE_ENV
        - name: PORT
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: PORT
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: ENVIRONMENT
        - name: NODE_VERSION
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: NODE_VERSION
        - name: PRODUCTION
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: PRODUCTION
        - name: SEMVERSION
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: SEMVERSION
        - name: VERSION
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: VERSION
        - name: ESI_CLIENTID
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: ESI_CLIENTID
        - name: ESI_STATE
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: ESI_STATE
        - name: CALLBACK_URL
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: CALLBACK_URL
        - name: ESIPROXY
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: ESIPROXY
        - name: OAUTHPROXY
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: OAUTHPROXY
        - name: PUBLICPROXY
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: PUBLICPROXY
        - name: BACKENDPROXY
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: BACKENDPROXY
        - name: NESTPROXY
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: NESTPROXY
        - name: APP_CODE
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: APP_CODE
        - name: MODULE_NAME
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: MODULE_NAME
        - name: APP_HOME
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: APP_HOME
        - name: APP_BASEREF
          valueFrom:
            configMapKeyRef:
              name: $APP_CODE-config
              key: APP_BASEREF
        ports:
        - containerPort: $PORT
        imagePullPolicy: Always
      serviceAccountName: default
